<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>7-Click Wikipedia Challenge</title>
  <style>
    body {
      background: #000;
      margin: 0;
      overflow: hidden;
      font-family: monospace;
    }
    #inputBox {
      position: absolute;
      top: 2rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      gap: 1rem;
    }
    input, button {
      padding: 0.5rem;
      font-size: 1rem;
    }
    .word {
      position: absolute;
      pointer-events: auto;
      opacity: 1;
      transition: opacity 0.5s ease;
      mix-blend-mode: difference;
    }
    .word a {
      text-decoration: none;
      color: white;
    }
    #clickCounter {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.2rem;
      color: white;
    }
    #targetWord {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.5rem;
      color: white;
      z-index: 1000;
      font-weight: bold;
    }
    #completionMessage {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 2rem;
      font-size: 1.5rem;
      color: green;
      z-index: 1000;
    }
    #instructionModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 3000;
      color: white;
      font-family: monospace;
      padding: 2rem;
      text-align: center;
    }
    #instructionModal h2 {
      margin-top: 0;
    }
    #instructionModal button {
      margin-top: 2rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="inputBox">
    <input type="text" id="urlInput" placeholder="Enter a Wikipedia URL"/>
    <button onclick="startChallenge()">Start Challenge</button>
  </div>
  <div id="output"></div>
  <div id="clickCounter">Clicks: 0</div>
  <div id="targetWord"></div>
  <div id="completionMessage"></div>

  <!-- Instruction Modal -->
  <div id="instructionModal">
    <div>
      <h2>Welcome to the 7-Click Wikipedia Challenge!</h2>
      <p style="max-width: 600px; margin: 1rem auto;">
        Enter a Wikipedia article URL to start. You might have to try a couple because they're currently a hit-or-miss :( A target word will be randomly chosen from that page. Click on floating words (which are hyperlinks) to navigate toward the wordâ€™s page. Reach it in exactly 7 clicks!
      </p>
      <button onclick="closeInstructions()">Start Playing</button>
    </div>
  </div>

  <script>
    let clickCount = 0;
    let targetWord = '';
    let currentUrl = '';
    let visitedPages = new Set();
    let targetPath = []; // Holds correct path (URLs)
    const output = document.getElementById('output');

    function closeInstructions() {
      document.getElementById('instructionModal').style.display = 'none';
    }

    function startChallenge() {
      const url = document.getElementById('urlInput').value;
      if (!url.startsWith('https://en.wikipedia.org/wiki/')) {
        alert('Please enter a valid Wikipedia URL.');
        return;
      }

      visitedPages.clear();
      targetPath = [];
      output.innerHTML = '';
      clickCount = 0;
      document.getElementById('completionMessage').textContent = '';
      document.getElementById('clickCounter').textContent = 'Clicks: 0';
      document.getElementById('targetWord').textContent = '';
      currentUrl = url;

      const pageTitle = url.split('/wiki/')[1];
      generateTargetPath(pageTitle, 7); // preload path
    }

    async function generateTargetPath(startTitle, depth) {
      let currentTitle = startTitle;
      targetPath = [currentTitle];

      for (let i = 0; i < depth; i++) {
        const html = await fetchPageHTML(currentTitle);
        const links = extractWikiLinks(html);

        if (links.length === 0) break;

        const randomLink = links[Math.floor(Math.random() * links.length)];
        currentTitle = randomLink.replace('/wiki/', '');
        targetPath.push(currentTitle);
      }

      const finalWord = decodeURIComponent(targetPath[targetPath.length - 1]).replace(/_/g, ' ');
      targetWord = finalWord;
      document.getElementById('targetWord').textContent = 'Target Word: ' + targetWord;

      loadPage(targetPath[0]);
    }

    function fetchPageHTML(title) {
      const apiURL = `https://en.wikipedia.org/api/rest_v1/page/html/${title}`;
      return fetch(apiURL)
        .then(res => {
          if (!res.ok) throw new Error("Fetch failed");
          return res.text();
        })
        .catch(err => {
          alert('Could not fetch Wikipedia page.');
          throw err;
        });
    }

    function extractWikiLinks(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const links = Array.from(doc.querySelectorAll('a'));
      return links
        .map(a => a.getAttribute('href'))
        .filter(href => href && href.startsWith('/wiki/') && !href.includes(':'));
    }

    async function loadPage(title) {
      const url = `https://en.wikipedia.org/wiki/${title}`;
      if (visitedPages.has(url)) return;
      visitedPages.add(url);

      const html = await fetchPageHTML(title);
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const links = Array.from(doc.querySelectorAll('a'));

      let delayCounter = 0;
      for (let link of links) {
        const href = link.getAttribute('href');
        const text = link.textContent.trim();
        if (!href || !href.startsWith('/wiki/') || href.includes(':') || text.length < 2) continue;

        const fullUrl = `https://en.wikipedia.org${href}`;
        const targetTitle = href.replace('/wiki/', '');

        showWord(text, targetTitle, delayCounter);
        delayCounter += 100;
      }
    }

    function showWord(word, nextTitle, delay) {
      setTimeout(() => {
        const wrapper = document.createElement('div');
        wrapper.className = 'word';
        wrapper.style.left = Math.random() * (window.innerWidth - 200) + 'px';
        wrapper.style.top = Math.random() * (window.innerHeight - 100) + 'px';
        wrapper.style.fontSize = (Math.random() * 2 + 1.2) + 'rem';

        const a = document.createElement('a');
        a.href = `https://en.wikipedia.org/wiki/${nextTitle}`;
        a.target = '_blank';
        a.textContent = word;
        a.onclick = (e) => {
          e.preventDefault();
          handleClick(nextTitle, word);
        };

        wrapper.appendChild(a);
        output.appendChild(wrapper);

        setTimeout(() => {
          wrapper.style.opacity = 0;
          setTimeout(() => wrapper.remove(), 500);
        }, 4000);
      }, delay);
    }

    function handleClick(nextTitle, clickedWord) {
      clickCount++;
      document.getElementById('clickCounter').textContent = 'Clicks: ' + clickCount;

      const cleanedClicked = clickedWord.toLowerCase().replace(/_/g, ' ');
      const cleanedTarget = targetWord.toLowerCase();

      if (cleanedClicked === cleanedTarget) {
        document.getElementById('completionMessage').textContent = `You found the word: "${clickedWord}". Challenge Complete!`;
        return;
      }

      if (clickCount >= 7) {
        document.getElementById('completionMessage').textContent = `You lost! The word was: ${targetWord}. Restarting...`;
        setTimeout(startChallenge, 4000);
        return;
      }

      output.innerHTML = '';
      loadPage(nextTitle);
    }
  </script>
</body>
</html>
